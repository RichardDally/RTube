name: Build and Publish

on:
  push:
    tags:
      - 'v*'  # Triggered on version tags (e.g., v0.1.0, v1.0.0)
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - PATCH
          - MINOR
          - MAJOR

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/rtube

jobs:
  bump-version:
    name: Bump version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    outputs:
      version: ${{ steps.bump.outputs.version }}
      version_num: ${{ steps.bump.outputs.version_num }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: bump
        run: |
          # Read current version from __version__.py
          CURRENT_VERSION=$(grep -oP '__version__ = "\K[^"]+' rtube/__version__.py)
          echo "Current version: $CURRENT_VERSION"

          # Parse version parts
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Bump based on input
          case "${{ github.event.inputs.bump }}" in
            MAJOR)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            MINOR)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            PATCH)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"

          # Update __version__.py
          sed -i "s/__version__ = \".*\"/__version__ = \"${NEW_VERSION}\"/" rtube/__version__.py

          # Update pyproject.toml
          sed -i "s/^version = \".*\"/version = \"${NEW_VERSION}\"/" pyproject.toml

          # Commit changes
          git add rtube/__version__.py pyproject.toml
          git commit -m "Bump version to ${NEW_VERSION}"

          # Create and push tag
          git tag "v${NEW_VERSION}"
          git push origin main --tags

          # Set outputs
          echo "version=v${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "version_num=${NEW_VERSION}" >> $GITHUB_OUTPUT

  build-wheel:
    name: Build Python wheel
    runs-on: ubuntu-latest
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped')
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      version_num: ${{ steps.get_version.outputs.version_num }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.version || github.ref }}
          fetch-depth: 0

      - name: Get version from tag or bump job
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ needs.bump-version.outputs.version }}"
            VERSION_NUM="${{ needs.bump-version.outputs.version_num }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION_NUM="${VERSION#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Run tests
        run: uv run pytest tests/ -v

      - name: Build package
        run: uv build

      - name: Store the distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

  build-docker:
    name: Build Docker image
    needs: build-wheel
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.build-wheel.outputs.version || github.ref }}

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (test only)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-to-pypi:
    name: Publish to PyPI
    needs: [build-wheel, build-docker]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/rtube
    permissions:
      id-token: write  # Required for OIDC trusted publishing

    steps:
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # No password needed - uses OIDC trusted publishing

  push-docker:
    name: Push Docker image to Docker Hub
    needs: [build-wheel, build-docker]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.build-wheel.outputs.version || github.ref }}

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ needs.build-wheel.outputs.version_num }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-github-release:
    name: Create GitHub Release
    needs: [build-wheel, publish-to-pypi, push-docker]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-wheel.outputs.version }}
          name: Release ${{ needs.build-wheel.outputs.version }}
          generate_release_notes: true
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  rollback-on-failure:
    name: Rollback on failure
    needs: [bump-version, build-wheel, build-docker, publish-to-pypi, push-docker, create-github-release]
    runs-on: ubuntu-latest
    if: failure()
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Delete GitHub Release if created
        if: needs.create-github-release.result == 'success' && (needs.publish-to-pypi.result == 'failure' || needs.push-docker.result == 'failure')
        run: |
          gh release delete ${{ needs.build-wheel.outputs.version }} --yes || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log failure
        run: |
          echo "::error::Pipeline failed. Manual intervention may be required."
          echo "Bump version result: ${{ needs.bump-version.result }}"
          echo "Wheel build result: ${{ needs.build-wheel.result }}"
          echo "Docker build result: ${{ needs.build-docker.result }}"
          echo "PyPI publish result: ${{ needs.publish-to-pypi.result }}"
          echo "Docker push result: ${{ needs.push-docker.result }}"
          echo "GitHub release result: ${{ needs.create-github-release.result }}"
          echo ""
          echo "If some steps succeeded but others failed, consider:"
          echo "1. Manually creating the GitHub release"
          echo "2. Or yanking the PyPI release if needed"
          echo "3. Or removing the Docker image tag if needed"
          echo "4. Or reverting the version bump commit if needed"
